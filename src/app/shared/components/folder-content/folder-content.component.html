<div class="folder-content-container">
  <!-- Breadcrumb Navigation -->
  @if (showBreadcrumbs && (breadcrumbs().length > 0 || folderId !== null)) {
  <nav class="breadcrumb-nav" aria-label="Breadcrumb">
    <ol class="breadcrumb-list">
      <!-- Always show root breadcrumb when not at root -->
      @if (folderId !== null) {
        <li class="breadcrumb-item">
          <button class="breadcrumb-link" (click)="navigateToRoot()">
            Root
          </button>
          <svg class="breadcrumb-separator" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </li>
      }
      
      @for (breadcrumb of breadcrumbs(); track breadcrumb.id; let isLast = $last) {
      <li class="breadcrumb-item" [class.active]="isLast">
        @if (!isLast) {
        <button class="breadcrumb-link" (click)="navigateToBreadcrumb(breadcrumb)">
          {{ breadcrumb.name }}
        </button>
        <svg class="breadcrumb-separator" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        } @else {
        <span class="breadcrumb-current">{{ breadcrumb.name }}</span>
        }
      </li>
      }
    </ol>
  </nav>
  }

  <!-- Content Area -->
  @if (loading()) {
  <!-- Loading state -->
  <div class="folder-content-loading">
    <div class="spinner"></div>
    <p>Loading folder contents...</p>
  </div>
  } @else if (templates().length === 0 && subfolders().length === 0) {
  <!-- Empty state -->
  <div class="folder-content-empty">
    <div class="empty-icon">
      <svg width="100%" height="100%" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
      </svg>
    </div>
    <h3>This folder is empty</h3>
    <p>Create templates or subfolders to organize your content</p>
    <div class="empty-actions">
      <button class="btn btn-primary" (click)="requestCreateFolder()">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
        </svg>
        Create Folder
      </button>
    </div>
  </div>
  } @else if (currentViewMode() === 'grid') {
  <!-- Grid view -->
  <div class="folder-content-grid">
    <!-- Subfolders -->
    @for (folder of subfolders(); track folder.id) {
    <div class="folder-item" [draggable]="enableDragDrop"
      (dragstart)="onDragStart($event, folder)" (click)="navigateToFolder(folder)">

      <!-- Folder actions -->
      <div class="item-actions" (click)="$event.stopPropagation()">
        <button type="button" class="btn btn-icon btn-xs btn-ghost" (click)="editFolder(folder, $event)" title="Edit folder">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        </button>
        <button type="button" class="btn btn-icon btn-xs btn-ghost text-danger" (click)="deleteFolder(folder, $event)" title="Delete folder">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>

      <div class="folder-icon">
        <svg width="48" height="48" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
        </svg>
      </div>

      <div class="folder-info">
        <h4 class="folder-name">{{ folder.name }}</h4>
        <p class="folder-meta">{{ folder.templatesCount }} templates</p>
      </div>
    </div>
    }

    <!-- Templates -->
    @for (template of templates(); track template.id) {
    <div class="template-item" [draggable]="enableDragDrop"
      (dragstart)="onDragStart($event, template)" (click)="openTemplate(template)">

      <!-- Template actions -->
      <div class="item-actions" (click)="$event.stopPropagation()">
        <button type="button" class="btn btn-icon btn-xs btn-ghost text-danger" (click)="deleteTemplate(template, $event)" title="Delete template">
          <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>

      <div class="template-header">
        <span class="template-type-badge">{{ template.type }}</span>
      </div>

      <div class="template-body">
        <h4 class="template-name">{{ template.name }}</h4>
        <p class="template-meta">Updated {{ formatDate(template.updatedAt) }}</p>
      </div>
    </div>
    }
  </div>
  } @else {
  <!-- List view -->
  <div class="folder-content-list">
    <table class="content-table">
      <thead>
        <tr>
          <th class="col-name">Name</th>
          <th class="col-type">Type</th>
          <th class="col-updated">Updated</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Subfolders -->
        @for (folder of subfolders(); track folder.id) {
        <tr class="folder-row" [draggable]="enableDragDrop"
          (dragstart)="onDragStart($event, folder)" (click)="navigateToFolder(folder)">
          <td class="col-name">
            <div class="name-cell">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              <strong>{{ folder.name }}</strong>
            </div>
          </td>
          <td class="col-type">
            <span class="type-badge folder-badge">Folder</span>
          </td>
          <td class="col-updated">{{ formatDate(folder.updatedAt) }}</td>
          <td class="col-actions" (click)="$event.stopPropagation()">
            <div class="action-buttons">
              <button type="button" class="btn btn-icon btn-sm btn-ghost" (click)="editFolder(folder, $event)" title="Edit folder">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button type="button" class="btn btn-icon btn-sm btn-ghost text-danger" (click)="deleteFolder(folder, $event)" title="Delete folder">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
              <button type="button" class="btn btn-icon btn-sm btn-ghost" (click)="navigateToFolder(folder)" title="Open folder">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
        }

        <!-- Templates -->
        @for (template of templates(); track template.id) {
        <tr class="template-row" [draggable]="enableDragDrop"
          (dragstart)="onDragStart($event, template)" (click)="openTemplate(template)">
          <td class="col-name">
            <div class="name-cell">
              <span class="template-icon">{{ getItemIcon(template) }}</span>
              <strong>{{ template.name }}</strong>
            </div>
          </td>
          <td class="col-type">
            <span class="type-badge template-badge">{{ template.type }}</span>
          </td>
          <td class="col-updated">{{ formatDate(template.updatedAt) }}</td>
          <td class="col-actions" (click)="$event.stopPropagation()">
            <div class="action-buttons">
              <button class="btn btn-icon btn-sm btn-ghost" (click)="openTemplate(template)" title="Edit">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button type="button" class="btn btn-icon btn-sm btn-ghost text-danger" (click)="deleteTemplate(template, $event)" title="Delete template">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }

  <!-- Pagination -->
  @if (totalElements() > 0 && totalPages() > 1) {
  <div class="folder-pagination">
    <div class="pagination-controls">
      <button class="btn btn-icon btn-sm btn-outline" [disabled]="currentPage() === 0"
        (click)="goToPage(currentPage() - 1)">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      @for (page of getPageNumbers(); track page) {
      @if (page === -1) {
      <span class="btn btn-sm btn-outline disabled">...</span>
      } @else {
      <button class="btn btn-sm" [class.btn-primary]="page === currentPage()"
        [class.btn-outline]="page !== currentPage()" (click)="goToPage(page)">
        {{ page + 1 }}
      </button>
      }
      }

      <button class="btn btn-icon btn-sm btn-outline" [disabled]="currentPage() === totalPages() - 1"
        (click)="goToPage(currentPage() + 1)">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

    <div class="pagination-info">
      Showing {{ currentPage() * pageSize() + 1 }} - {{ getEndRange() }}
      of {{ totalElements() }} items
    </div>
  </div>
  }
</div>

<!-- Edit Folder Dialog -->
@if (showEditFolderDialog()) {
<div class="modal-overlay" (click)="cancelFolderDialog()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Edit Folder</h3>
      <button class="btn btn-icon btn-sm btn-ghost" (click)="cancelFolderDialog()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="editFolderName">Folder Name</label>
        <input 
          id="editFolderName"
          type="text" 
          class="form-control" 
          [ngModel]="editFolderName()"
          (ngModelChange)="editFolderName.set($event)"
          placeholder="Enter folder name"
          [disabled]="folderActionLoading()"
          (keyup.enter)="confirmEditFolder()"
        />
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="cancelFolderDialog()" [disabled]="folderActionLoading()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" (click)="confirmEditFolder()" 
              [disabled]="!editFolderName().trim() || folderActionLoading()">
        @if (folderActionLoading()) {
          <span class="spinner-sm"></span>
          Updating...
        } @else {
          Update Folder
        }
      </button>
    </div>
  </div>
</div>
}

<!-- Delete Folder Dialog -->
@if (showDeleteFolderDialog()) {
<div class="modal-overlay" (click)="cancelFolderDialog()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Delete Folder</h3>
      <button class="btn btn-icon btn-sm btn-ghost" (click)="cancelFolderDialog()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="alert alert-warning">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        <div>
          <strong>Are you sure you want to delete this folder?</strong>
          <p>Folder: <strong>{{ editingFolder()?.name }}</strong></p>
          <p>This action cannot be undone. The folder must be empty to be deleted.</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="cancelFolderDialog()" [disabled]="folderActionLoading()">
        Cancel
      </button>
      <button type="button" class="btn btn-danger" 
              (click)="confirmDeleteFolder()" 
              [disabled]="folderActionLoading()"
              style="cursor: pointer !important;">
        @if (folderActionLoading()) {
          <span class="spinner-sm"></span>
          Deleting...
        } @else {
          Delete Folder
        }
      </button>
    </div>
  </div>
</div>
}

<!-- Delete Template Dialog -->
@if (showDeleteTemplateDialog()) {
<div class="modal-overlay" (click)="cancelTemplateDialog()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Delete Template</h3>
      <button class="btn btn-icon btn-sm btn-ghost" (click)="cancelTemplateDialog()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="alert alert-warning">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        <div>
          <strong>Are you sure you want to delete this template?</strong>
          <p>Template: <strong>{{ editingTemplate()?.name }}</strong></p>
          <p>This action cannot be undone.</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline" (click)="cancelTemplateDialog()" [disabled]="templateActionLoading()">
        Cancel
      </button>
      <button type="button" class="btn btn-danger" 
              (click)="confirmDeleteTemplate()" 
              [disabled]="templateActionLoading()"
              style="cursor: pointer !important;">
        @if (templateActionLoading()) {
          <span class="spinner-sm"></span>
          Deleting...
        } @else {
          Delete Template
        }
      </button>
    </div>
  </div>
</div>
}
