<div class="template-editor-enhanced">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          <input type="text" class="template-name-input" [(ngModel)]="templateName" placeholder="Enter template name"
            (blur)="updateTemplateName()">
        </h1>
        <p class="page-subtitle">
          <span class="template-type-badge">{{ templateType() }}</span>
          <!-- <span class="separator">‚Ä¢</span>
          <span>{{ isHtmlType() ? 'HTML Template Editor' : 'Text Template Editor' }}</span> -->
        </p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" (click)="saveTemplate()" [disabled]="saving()">
          @if (saving()) {
            <span class="spinner-sm"></span>
          } @else {
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
            </svg>
          }
          <span>Save</span>
        </button>

        <button class="btn btn-outline variables-btn" (click)="toggleVariablesPanel()"
          [class.active]="showVariablesPanel()" title="Manage template attributes">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          <span>Attributes</span>
          <span class="btn-badge">{{ attributes().length }}</span>
        </button>

        <button class="btn btn-primary" (click)="exportToPdf()" 
                [disabled]="!templateId() || loading() || pdfExporting()" 
                [class.loading]="pdfExporting()"
                title="Generate PDF">
          @if (pdfExporting()) {
            <div class="spinner-container">
              <div class="spinner"></div>
            </div>
          } @else {
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          }
          <span>
            @if (pdfExporting()) {
              Generating...
            } @else {
              PDF
            }
          </span>
        </button>
      </div>
    </div>

    <!-- Filters & Tools Bar -->
    <div class="filters-bar">
      <div class="editor-tools">
        <!-- Page Orientation Selector -->
        <div class="tool-group">
          <label class="tool-label">Orientation:</label>
          <select class="form-control form-control-sm" [(ngModel)]="pageOrientation" 
                  [title]="PageOrientationDescriptions[pageOrientation()]"
                  (change)="onPageOrientationChange()">
            <option [value]="PageOrientation.PORTRAIT" 
                    [title]="PageOrientationDescriptions[PageOrientation.PORTRAIT]">
              {{ PageOrientationLabels[PageOrientation.PORTRAIT] }}
            </option>
            <option [value]="PageOrientation.LANDSCAPE" 
                    [title]="PageOrientationDescriptions[PageOrientation.LANDSCAPE]">
              {{ PageOrientationLabels[PageOrientation.LANDSCAPE] }}
            </option>
          </select>
        </div>

        <!-- Editor Tab -->
        <div class="tool-group">
          <button class="btn-tab active">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <span>{{ isTxtType() ? 'Text Editor' : 'HTML Editor' }}</span>
            @if (htmlContent()) {
              <span class="tab-info">{{ htmlContent().length }} chars</span>
            }
          </button>
        </div>
      </div>

      <div class="filter-actions">
        <!-- Add Page Button (only for HTML templates) -->
        @if (isHtmlType()) {
          <button class="btn-icon" (click)="openPageModal()" title="Add new page">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        }

        <!-- Help Button -->
        <button class="btn-icon" (click)="showHelp = !showHelp" [class.active]="showHelp"
          title="Show help and tips">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Variables Panel (Overlay) -->
  @if (showVariablesPanel()) {
  <div class="variables-panel-overlay" (click)="closeVariablesPanel()">
    <div class="variables-panel" (click)="$event.stopPropagation()">
      <div class="variables-panel-header">
        <div class="panel-title">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          <h3>Attributes</h3>
          <span class="variables-count">{{ attributes().length }} variables</span>
        </div>
        <div class="panel-actions">
          <button class="btn btn-sm btn-primary" (click)="openAttributeModal()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <!-- Add Attribute -->
          </button>
          <button class="btn-close" (click)="closeVariablesPanel()">√ó</button>
        </div>
      </div>

      <div class="variables-panel-content">
        @if (attributes().length > 0) {
        <div class="variables-grid">
          @for (attr of attributes(); track attr.id) {
          <div class="variable-card">
            <div class="variable-header">
              <div class="variable-type-badge" [attr.data-type]="attr.attributeType">
                {{ attr.attributeType }}
              </div>
              <div class="variable-actions">
                <button class="btn-icon-xs" (click)="editAttribute(attr)" title="Edit">
                  <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button class="btn-icon-xs danger" (click)="confirmDeleteAttribute(attr)" title="Delete">
                  <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
            <div class="variable-content">
              <div class="variable-key">{{ attr.attributeKey }}</div>
              <div class="variable-value">{{ attr.attributeValue || '(no default)' }}</div>
              <div class="variable-description" *ngIf="attr.description">{{ attr.description }}</div>
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="variables-empty-state">
          <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          <h4>No Variables Yet</h4>
          <p>Add variables like {{ '{' }}{{ '{' }}name{{ '}' }}{{ '}' }}, {{ '{' }}{{ '{' }}email{{ '}' }}{{ '}' }} to
            make your template dynamic</p>
          <button class="btn btn-primary" (click)="openAttributeModal()">Add Your First Variable</button>
        </div>
        }
      </div>
    </div>
  </div>
  }

  <!-- Main Editor Area (Full Width) -->
  <div class="editor-main-fullwidth">


    <!-- Help Panel -->
    @if (showHelp) {
    <div class="help-panel">
      <div class="help-content">
        <div class="help-sections">
          <div class="help-section">
            <h4>üìÑ Pages</h4>
            <p>Break your template into multiple pages for better organization. Each page can have different content.
            </p>
          </div>

          <div class="help-section">
            <h4>üè∑Ô∏è Variables</h4>
            <p>Use variables like <code>{{ '{' }}{{ '{' }}name{{ '}' }}{{ '}' }}</code> or
              <code>{{ '{' }}{{ '{' }}email{{ '}' }}{{ '}' }}</code> to make your template dynamic.
            </p>
          </div>

          <div class="help-section">
            <h4>‚úèÔ∏è Editor</h4>
            <p>Write HTML in the editor and see live preview. Use the toolbar to insert FreeMarker syntax.</p>
          </div>

          <div class="help-section">
            <h4>üëÅÔ∏è Preview</h4>
            <p>See how your template looks with real data. Variables will be replaced with their values.</p>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Tab Content -->
    <div class="editor-content-fullwidth">
      @if (activeTab() === 'html') {
      <app-editor-content [content]="htmlContent()" [editorType]="isTxtType() ? 'text' : 'html'"
        [availableVariables]="allVariables()" (contentChange)="onEditorContentChange($event)"
        (textSelection)="onEditorTextSelection($event)" (freemarkerInsert)="onEditorFreeMarkerInsert($event)">
      </app-editor-content>
      }


    </div>

    <!-- Book-Style Pages Pagination Footer -->
    @if (isHtmlType()) {
    <div class="pages-pagination-footer">
      <div class="pagination-container">
        @if (pages().length > 0) {
        <div class="pagination-info">
          <span class="page-indicator">
            Page {{ getCurrentPageIndex() + 1 }} of {{ pages().length }}
          </span>
          <!-- <span class="page-title">{{ activePage()?.name || 'Untitled Page' }}</span> -->
        </div>

        <div class="pagination-controls">
          <button class="pagination-btn prev" (click)="goToPreviousPage()" [disabled]="getCurrentPageIndex() === 0"
            title="Previous page">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="btn-text">Previous</span>
          </button>

          <!-- Page Numbers -->
          <div class="page-numbers">
            @for (page of pages(); track page.id; let idx = $index) {
            <button class="page-number" [class.active]="activePage()?.id === page.id" (click)="selectPage(page)"
              [title]="page.name || 'Page ' + (idx + 1)" [attr.aria-label]="'Go to page ' + (idx + 1)">
              {{ idx + 1 }}
            </button>
            }
          </div>

          <button class="pagination-btn next" (click)="goToNextPage()"
            [disabled]="getCurrentPageIndex() === pages().length - 1" title="Next page">
            <span class="btn-text">Next</span>
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
        } @else {
        <!-- No Pages State -->
        <div class="no-pages-state">
          <div class="no-pages-info">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>No pages yet</span>
          </div>
          <button class="btn btn-primary" (click)="openPageModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Create First Page
          </button>
        </div>
        }

        <div class="pagination-actions">
          <button class="btn-icon-sm" (click)="editPage(activePage()!)" title="Edit current page" *ngIf="activePage()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <button class="btn-icon-sm danger" (click)="confirmDeletePage(activePage()!)" title="Delete current page"
            *ngIf="activePage() && pages().length > 1">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
    }
  </div>



  <!-- Type Selection Modal -->
  @if (showTypeModal()) {
  <div class="modal-overlay" (click)="closeModal('type')">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Select Template Type</h2>
        <button class="btn-close" (click)="closeModal('type')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="type-cards">
          <div class="type-card" (click)="selectType(TemplateType.HTML)">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3>HTML Template</h3>
            <p>Rich HTML editor with multiple pages, styling, and live preview</p>
          </div>

          <div class="type-card" (click)="selectType(TemplateType.TXT)">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3>Text Template</h3>
            <p>Simple plain text template for emails and messages</p>
          </div>

          <div class="type-card disabled">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3>Form Template</h3>
            <p>Coming soon - Dynamic form builder</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Page Modal -->
  @if (showPageModal()) {
  <div class="modal-overlay" (click)="closeModal('page')">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingPageId() ? 'Edit Page' : 'Add Page' }}</h2>
        <button class="btn-close" (click)="closeModal('page')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Page Name *</label>
          <input type="text" class="form-control" [(ngModel)]="pageName" placeholder="Page 1">
        </div>
        <div class="form-group">
          <label>Initial Content (optional)</label>
          <textarea class="form-control" [(ngModel)]="pageContent" rows="4"
            placeholder="<h1>Page content...</h1>"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeModal('page')">Cancel</button>
        <button class="btn btn-primary" (click)="savePage()" [disabled]="!isPageFormValid() || saving()">
          @if (saving()) {
            <span class="spinner-small"></span>
          }
          {{ editingPageId() ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Attribute Modal -->
  @if (showAttributeModal()) {
  <div class="modal-overlay" (click)="closeModal('attribute')">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingAttributeId() ? 'Edit Attribute' : 'Add Attribute' }}</h2>
        <button class="btn-close" (click)="closeModal('attribute')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Attribute Key *</label>
          <input type="text" class="form-control" [(ngModel)]="attributeKey"
            placeholder="e.g., subject, recipient, company">
        </div>
        <div class="form-group">
          <label>Default Value</label>
          <input type="text" class="form-control" [(ngModel)]="attributeValue" placeholder="Default value">
        </div>
        <div class="form-group">
          <label>Type</label>
          <select class="form-control" [(ngModel)]="attributeType">
            <option value="STRING">String</option>
            <option value="NUMBER">Number</option>
            <option value="DATE">Date</option>
            <option value="BOOLEAN">Boolean</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea class="form-control" [(ngModel)]="attributeDescription" rows="2"
            placeholder="What is this attribute for?"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeModal('attribute')">Cancel</button>
        <button class="btn btn-primary" (click)="saveAttribute()" [disabled]="!isAttributeFormValid() || saving()">
          @if (saving()) {
            <span class="spinner-small"></span>
          }
          {{ editingAttributeId() ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal()) {
  <div class="modal-overlay" (click)="closeModal('delete')">
    <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Delete</h2>
        <button class="btn-close" (click)="closeModal('delete')">√ó</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ deleteName() }}</strong>?</p>
        <p class="text-danger">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeModal('delete')">Cancel</button>
        <button class="btn btn-danger" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
  }

  <!-- PDF Parameters Dialog -->
  <app-pdf-parameters-dialog
    [show]="showPdfParametersDialog()"
    [templateContent]="templateContent()"
    [templatePages]="templatePages()"
    (close)="closePdfParametersDialog()"
    (generatePdf)="onGeneratePdf($event)"
    (skipParameters)="onSkipParameters()">
  </app-pdf-parameters-dialog>
</div>