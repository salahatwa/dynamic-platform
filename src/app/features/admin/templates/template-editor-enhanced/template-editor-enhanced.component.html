<div class="template-editor-enhanced">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          <input type="text" class="template-name-input" [(ngModel)]="templateName" placeholder="Enter template name"
            (blur)="updateTemplateName()">
        </h1>
        <!-- <p class="page-subtitle">
          <span class="template-type-badge">{{ templateType() }}</span>
           <span class="separator">‚Ä¢</span>
          <span>{{ isHtmlType() ? 'HTML Template Editor' : 'Text Template Editor' }}</span> 
        </p> -->
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" (click)="saveTemplate()" [disabled]="saving()">
          @if (saving()) {
            <span class="spinner-sm"></span>
          } @else {
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
            </svg>
          }
          <span>Save</span>
        </button>

        <button class="btn btn-outline variables-btn" (click)="toggleVariablesPanel()"
          [class.active]="showVariablesPanel()" title="Manage template attributes">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          <span>Attributes</span>
          <span class="btn-badge">{{ attributes().length }}</span>
        </button>

        <button class="btn btn-primary" (click)="exportToPdf()" 
                [disabled]="!templateId() || loading() || pdfExporting()" 
                [class.loading]="pdfExporting()"
                title="Generate PDF">
          @if (pdfExporting()) {
            <div class="spinner-container">
              <div class="spinner"></div>
            </div>
          } @else {
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          }
          <span>
            @if (pdfExporting()) {
              Generating...
            } @else {
              PDF
            }
          </span>
        </button>
      </div>
    </div>

    <!-- Filters & Tools Bar -->
    <div class="filters-bar">
      <div class="editor-tools">
        <!-- Page Orientation moved to filter-actions as icon button -->

        <!-- Editor Tab -->
        <div class="tool-group">
          <button class="btn-tab active">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <span>{{ isTxtType() ? 'Text Editor' : 'HTML Editor' }}</span>
            @if (htmlContent()) {
              <span class="tab-info">{{ htmlContent().length }} chars</span>
            }
          </button>
        </div>
      </div>

      <div class="filter-actions">
        <!-- Add Page Button (only for HTML templates) -->
        @if (isHtmlType()) {
          <button class="btn-icon" (click)="openPageModal()" title="Add new page">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        }

        <!-- Page Orientation Toggle Button -->
        <button class="btn-icon orientation-toggle" 
                (click)="togglePageOrientation()" 
                [title]="'Page Orientation: ' + PageOrientationLabels[pageOrientation()]">
          @if (pageOrientation() === PageOrientation.PORTRAIT) {
            <!-- Portrait Icon -->
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="6" y="2" width="12" height="20" rx="2" ry="2" stroke-width="2"/>
              <line x1="12" y1="18" x2="12" y2="18" stroke-width="2" stroke-linecap="round"/>
            </svg>
          } @else {
            <!-- Landscape Icon -->
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="2" y="6" width="20" height="12" rx="2" ry="2" stroke-width="2"/>
              <line x1="18" y1="12" x2="18" y2="12" stroke-width="2" stroke-linecap="round"/>
            </svg>
          }
        </button>

        <!-- Help Button -->
        <button class="btn-icon" (click)="showHelp = !showHelp" [class.active]="showHelp"
          title="Show help and tips">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Variables Panel (Overlay) -->
  <app-variables-panel
    [show]="showVariablesPanel()"
    [attributes]="attributes()"
    (close)="onVariablesPanelClose()"
    (addAttribute)="onVariablesPanelAddAttribute()"
    (editAttribute)="onVariablesPanelEditAttribute($event)"
    (deleteAttribute)="onVariablesPanelDeleteAttribute($event)">
  </app-variables-panel>

  <!-- Main Editor Area (Full Width) -->
  <div class="editor-main-fullwidth">


    <!-- Help Panel -->
    @if (showHelp) {
    <div class="help-panel-overlay" (click)="closeHelp()">
      <div class="help-panel" (click)="$event.stopPropagation()">
        <div class="help-header">
          <div class="help-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3>Help & Tips</h3>
          </div>
          <button class="help-close-btn" (click)="closeHelp()" title="Close help">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="help-content">
          <div class="help-sections">
            <div class="help-section">
              <h4>üìÑ Pages</h4>
              <p>Break your template into multiple pages for better organization. Each page can have different content.
              </p>
            </div>

            <div class="help-section">
              <h4>üè∑Ô∏è Variables</h4>
              <p>Use variables like <code>{{ '{' }}{{ '{' }}name{{ '}' }}{{ '}' }}</code> or
                <code>{{ '{' }}{{ '{' }}email{{ '}' }}{{ '}' }}</code> to make your template dynamic.
              </p>
            </div>

            <div class="help-section">
              <h4>‚úèÔ∏è Editor</h4>
              <p>Write HTML in the editor and see live preview. Use the toolbar to insert FreeMarker syntax.</p>
            </div>

            <div class="help-section">
              <h4>üëÅÔ∏è Preview</h4>
              <p>See how your template looks with real data. Variables will be replaced with their values.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Tab Content -->
    <div class="editor-content-fullwidth">
      @if (activeTab() === 'html') {
      <app-editor-content [content]="htmlContent()" [editorType]="isTxtType() ? 'text' : 'html'"
        [availableVariables]="allVariables()" (contentChange)="onEditorContentChange($event)"
        (textSelection)="onEditorTextSelection($event)" (freemarkerInsert)="onEditorFreeMarkerInsert($event)">
      </app-editor-content>
      }


    </div>

    <!-- Book-Style Pages Pagination Footer -->
    @if (isHtmlType()) {
    <div class="pages-pagination-footer">
      <div class="pagination-container">
        @if (pages().length > 0) {
        <div class="pagination-info">
          <span class="page-indicator">
            Page {{ getCurrentPageIndex() + 1 }} of {{ pages().length }}
          </span>
          <!-- <span class="page-title">{{ activePage()?.name || 'Untitled Page' }}</span> -->
        </div>

        <div class="pagination-controls">
          <button class="pagination-btn prev" (click)="goToPreviousPage()" [disabled]="getCurrentPageIndex() === 0"
            title="Previous page">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span class="btn-text">Previous</span>
          </button>

          <!-- Page Numbers -->
          <div class="page-numbers">
            @for (page of pages(); track page.id; let idx = $index) {
            <button class="page-number" [class.active]="activePage()?.id === page.id" (click)="selectPage(page)"
              [title]="page.name || 'Page ' + (idx + 1)" [attr.aria-label]="'Go to page ' + (idx + 1)">
              {{ idx + 1 }}
            </button>
            }
          </div>

          <button class="pagination-btn next" (click)="goToNextPage()"
            [disabled]="getCurrentPageIndex() === pages().length - 1" title="Next page">
            <span class="btn-text">Next</span>
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
        } @else {
        <!-- No Pages State -->
        <div class="no-pages-state">
          <div class="no-pages-info">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>No pages yet</span>
          </div>
          <button class="btn btn-primary" (click)="openPageModal()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Create First Page
          </button>
        </div>
        }

        <div class="pagination-actions">
          <button class="btn-icon-sm" (click)="editPage(activePage()!)" title="Edit current page" *ngIf="activePage()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <button class="btn-icon-sm danger" (click)="confirmDeletePage(activePage()!); $event.stopPropagation()" title="Delete current page"
            *ngIf="activePage() && pages().length > 1">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
    }
  </div>



  <!-- Type Selection Dialog -->
  <app-type-selection-dialog
    [show]="showTypeModal()"
    (close)="closeModal('type')"
    (typeSelected)="onTypeSelected($event)">
  </app-type-selection-dialog>

  <!-- Page Dialog -->
  <app-page-dialog
    [show]="showPageModal()"
    [isEditing]="!!editingPageId()"
    [saving]="saving()"
    [pageName]="pageName()"
    (close)="closeModal('page')"
    (save)="onPageDialogSave($event)">
  </app-page-dialog>

  <!-- Attribute Dialog -->
  <app-attribute-dialog
    [show]="showAttributeModal()"
    [isEditing]="!!editingAttributeId()"
    [saving]="saving()"
    [attributeKey]="attributeKey()"
    [attributeValue]="attributeValue()"
    [attributeType]="attributeType()"
    [attributeDescription]="attributeDescription()"
    (close)="closeModal('attribute')"
    (save)="onAttributeDialogSave($event)">
  </app-attribute-dialog>

  <!-- Delete Confirmation Dialog -->
  <app-delete-confirmation-dialog
    [show]="showDeleteModal()"
    [itemName]="deleteName()"
    [itemType]="deleteType() || ''"
    (close)="closeModal('delete')"
    (confirm)="onDeleteConfirmed()">
  </app-delete-confirmation-dialog>

  <!-- PDF Parameters Dialog -->
  <app-pdf-parameters-dialog
    [show]="showPdfParametersDialog()"
    [templateContent]="templateContent()"
    [templatePages]="templatePages()"
    (close)="closePdfParametersDialog()"
    (generatePdf)="onGeneratePdf($event)"
    (skipParameters)="onSkipParameters()">
  </app-pdf-parameters-dialog>
</div>