<div class="admin-page-container">
  <div class="admin-page-header">
    <div class="admin-header-content">
      <div class="admin-title-section">
        <h1>{{ 'templates.title' | translate }}</h1>
        <p class="subtitle">{{ 'templates.subtitle' | translate }}</p>
      </div>
      <div class="admin-header-actions">
        <app-button *hasPermission="'templates:create'" variant="primary" (click)="createNew()">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          {{ 'templates.newTemplate' | translate }}
        </app-button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="admin-filters-section">
      <div class="admin-filters-grid">
        <div class="search-filter">
          <span class="search-icon">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </span>
          <input type="text" placeholder="{{ 'templates.searchPlaceholder' | translate }}" [(ngModel)]="searchQuery"
            (input)="onSearch()" class="search-input" />
          @if (searchQuery) {
          <button class="clear-btn" (click)="clearSearch()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          }
        </div>

        <div class="filter-item filter-dropdown-wrapper">
          <button class="form-control d-flex align-items-center justify-content-between bg-white cursor-pointer"
            (click)="showFiltersDropdown.set(!showFiltersDropdown())">
            <div class="d-flex align-items-center gap-2">
              <span>{{ getSelectedTypeLabel() }}</span>
            </div>
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              [class.rotate-180]="showFiltersDropdown()" class="transition-transform">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          @if (showFiltersDropdown()) {
          <div class="dropdown-menu show" style="width: 100%; margin-top: 0.5rem;">
            @for (type of templateTypes; track type.value) {
            <button class="dropdown-item d-flex align-items-center gap-2" [class.active]="selectedType() === type.value"
              (click)="selectTypeFromDropdown(type.value)">
              <span class="filter-icon">{{ type.icon }}</span>
              <span>{{ ('templates.type.' + type.value) | translate }}</span>
              @if (selectedType() === type.value) {
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                class="ms-auto text-primary">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              }
            </button>
            }
          </div>
          }
        </div>

        <div class="view-toggle ms-auto">
          <button class="btn btn-icon" [class.btn-primary]="activeView() === 'grid'"
            [class.btn-outline]="activeView() !== 'grid'" (click)="activeView.set('grid')"
            title="{{ 'templates.gridView' | translate }}">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
              <path d="M10 3H3v7h7V3zM21 3h-7v7h7V3zM21 14h-7v7h7v-7zM10 14H3v7h7v-7z" />
            </svg>
          </button>
          <button class="btn btn-icon" [class.btn-primary]="activeView() === 'list'"
            [class.btn-outline]="activeView() !== 'list'" (click)="activeView.set('list')"
            title="{{ 'templates.listView' | translate }}">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    @if (loading()) {
    <div class="admin-empty-state">
      <div class="spinner"></div>
      <p>{{ 'templates.loading' | translate }}</p>
    </div>
    } @else if (skeletonLoading()) {
    <div class="admin-grid">
      @for (i of [1,2,3,4,5,6]; track i) {
      <div class="admin-card">
        <div class="admin-card-body">
          <div class="skeleton-title"
            style="height: 20px; width: 60%; background: var(--surface-hover); margin-bottom: 1rem; border-radius: 4px;">
          </div>
          <div class="skeleton-text"
            style="height: 14px; width: 80%; background: var(--surface-hover); border-radius: 4px;"></div>
        </div>
      </div>
      }
    </div>
    } @else if (templates().length === 0) {
    <div class="admin-empty-state">
      <div class="empty-icon">
        <svg width="100%" height="100%" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      </div>
      <h3>{{ 'templates.emptyTitle' | translate }}</h3>
      <p>{{ 'templates.emptyDesc' | translate }}</p>
      <app-button *hasPermission="'templates:create'" variant="primary" (click)="createNew()">{{ 'templates.createTemplate' | translate }}</app-button>
    </div>
    } @else {
    @if (activeView() === 'grid') {
    <div class="admin-grid">
      @for (template of templates(); track template.id) {
      <div class="admin-card">
        <div class="admin-card-header">
          <span class="status-badge neutral">
            {{ template.type }}
          </span>
          <button class="status-badge info cursor-pointer border-0" (click)="openVersionsDialog(template)"
            title="{{ 'templates.viewVersions' | translate }}">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="me-1">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{{ getVersionCount(template.id) }} {{ 'templates.versionsWord' | translate }}</span>
          </button>
        </div>

        <div class="admin-card-body">
          <h3 class="admin-card-title">{{ template.name }}</h3>

          <div class="admin-card-meta">
            <div class="meta-row">
              <span class="label">{{ 'templates.updatedPrefix' | translate }}</span>
              <span class="value">{{ formatDate(template.updatedAt) }}</span>
            </div>
          </div>
        </div>

        <div class="card-footer bg-transparent border-top border-light p-3 d-flex justify-content-end gap-2">
          <button class="btn btn-icon btn-sm btn-ghost" (click)="openAuditDialog(template)"
            title="{{ 'templates.auditHistory' | translate }}">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </button>
          <button *hasPermission="'templates:update'" class="btn btn-icon btn-sm btn-ghost text-primary" (click)="editTemplate(template.id)"
            title="{{ 'common.edit' | translate }}">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <button *hasPermission="'templates:create'" class="btn btn-icon btn-sm btn-ghost text-info" (click)="openDuplicateDialog(template)"
            title="{{ 'common.duplicate' | translate }}">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </button>
          <button *hasPermission="'templates:delete'" class="btn btn-icon btn-sm btn-ghost text-danger" (click)="openDeleteDialog(template)"
            title="{{ 'common.delete' | translate }}">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
      }
    </div>
    } @else {
    <div class="admin-table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>{{ 'templates.table.name' | translate }}</th>
            <th>{{ 'templates.table.type' | translate }}</th>
            <th>{{ 'templates.table.versions' | translate }}</th>
            <th>{{ 'templates.table.updated' | translate }}</th>
            <th>{{ 'templates.table.actions' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          @for (template of templates(); track template.id) {
          <tr class="cursor-pointer" (click)="editTemplate(template.id)">
            <td><strong>{{ template.name }}</strong></td>
            <td><span class="status-badge neutral">{{ template.type }}</span></td>
            <td>
              <button class="status-badge info cursor-pointer border-0"
                (click)="$event.stopPropagation(); openVersionsDialog(template)">
                {{ getVersionCount(template.id) }}
              </button>
            </td>
            <td>{{ formatDate(template.updatedAt) }}</td>
            <td (click)="$event.stopPropagation()">
              <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-icon btn-sm btn-ghost" (click)="openAuditDialog(template)"
                  title="{{ 'templates.auditHistory' | translate }}">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </button>
                <button *hasPermission="'templates:create'" class="btn btn-icon btn-sm btn-ghost text-info" (click)="openDuplicateDialog(template)"
                  title="{{ 'common.duplicate' | translate }}">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
                <button *hasPermission="'templates:delete'" class="btn btn-icon btn-sm btn-ghost text-danger" (click)="openDeleteDialog(template)"
                  title="{{ 'common.delete' | translate }}">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }

    @if (totalPages() > 1) {
    <div class="pagination-container d-flex justify-content-center mt-4">
      <div class="d-flex gap-2">
        <button class="btn btn-icon btn-sm btn-outline" [disabled]="currentPage() === 0"
          (click)="goToPage(currentPage() - 1)">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        @for (page of getPageNumbers(); track page) {
          @if (page === -1) {
            <span class="btn btn-sm btn-outline disabled">...</span>
          } @else {
            <button class="btn btn-sm" [class.btn-primary]="page === currentPage()"
              [class.btn-outline]="page !== currentPage()" (click)="goToPage(page)">
              {{ page + 1 }}
            </button>
          }
        }

        <button class="btn btn-icon btn-sm btn-outline" [disabled]="currentPage() === totalPages() - 1"
          (click)="goToPage(currentPage() + 1)">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </div>
    }
    }

    <!-- Dialogs -->
    @if (dialog().show) {
    <div class="modal-overlay" (click)="closeDialog()">
      <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header border-0 pb-0">
          <button class="btn-close ms-auto" (click)="closeDialog()">×</button>
        </div>
        <div class="modal-body text-center pt-0">
          @if (dialog().type === 'delete') {
          <div class="mx-auto rounded-circle d-flex align-items-center justify-content-center mb-3"
            style="width: 48px; height: 48px; background: var(--danger-light); color: var(--danger);">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </div>
          <h2 class="h5 mb-2">{{ 'templates.dialog.deleteTitle' | translate }}</h2>
          <p class="text-secondary mb-0">{{ 'templates.dialog.deleteConfirmPrefix' | translate }} <strong>{{
              dialog().template?.name }}</strong>? {{ 'templates.dialog.cannotUndo' | translate }}</p>
          } @else if (dialog().type === 'duplicate') {
          <div class="mx-auto rounded-circle d-flex align-items-center justify-content-center mb-3"
            style="width: 48px; height: 48px; background: var(--primary-light); color: var(--primary);">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </div>
          <h2 class="h5 mb-2">{{ 'templates.dialog.duplicateTitle' | translate }}</h2>
          <p class="text-secondary mb-0">{{ 'templates.dialog.duplicateConfirmPrefix' | translate }} <strong>{{
              dialog().template?.name }}</strong>?</p>
          }
        </div>
        <div class="modal-footer justify-content-center border-0 pt-0">
          <button class="btn btn-secondary" (click)="closeDialog()" [disabled]="dialog().loading">
            {{ 'common.cancel' | translate }}
          </button>
          <button class="btn" [class.btn-danger]="dialog().type === 'delete'"
            [class.btn-primary]="dialog().type === 'duplicate'" (click)="confirmDialog()" [disabled]="dialog().loading">
            @if (dialog().loading) {
            <span class="spinner-sm me-2"></span>
            <span>{{ 'common.processing' | translate }}</span>
            } @else {
            <span>{{ dialog().type === 'delete' ? ( 'common.delete' | translate ) : ( 'common.duplicate' | translate )
              }}</span>
            }
          </button>
        </div>
      </div>
    </div>
    }

    @if (versionsDialog().show) {
    <div class="modal-overlay" (click)="closeVersionsDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ 'templates.versionHistory' | translate }}</h2>
          <button class="btn-close" (click)="closeVersionsDialog()">×</button>
        </div>

        <div class="modal-body">
          <h3 class="h6 mb-3 text-primary">{{ versionsDialog().template?.name }}</h3>

          @if (versionsDialog().loading) {
          <div class="text-center py-4">
            <div class="spinner mb-2 mx-auto"></div>
            <p class="text-secondary">{{ 'templates.versionLoading' | translate }}</p>
          </div>
          } @else if (versionsDialog().versions.length === 0) {
          <div class="text-center py-4 text-secondary">
            <p>{{ 'templates.versionEmpty' | translate }}</p>
          </div>
          } @else {
          <div class="d-flex flex-column gap-3">
            @for (version of versionsDialog().versions; track version.id) {
            <div class="card bg-surface border">
              <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-bold">{{ 'templates.versionWord' | translate }} {{ version.version }}</span>
                  <span class="text-secondary small">{{ formatTimestamp(version.createdAt) }}</span>
                </div>
                <p class="mb-0 text-secondary small">{{ version.changeLog || ( 'templates.noChangeLog' | translate ) }}
                </p>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
    }

    @if (auditDialog().show) {
    <div class="modal-overlay" (click)="closeAuditDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ 'templates.auditHistory' | translate }}</h2>
          <button class="btn-close" (click)="closeAuditDialog()">×</button>
        </div>

        <div class="modal-body">
          <h3 class="h6 mb-3 text-primary">{{ auditDialog().template?.name }}</h3>

          @if (auditDialog().loading) {
          <div class="text-center py-4">
            <div class="spinner mb-2 mx-auto"></div>
            <p class="text-secondary">{{ 'templates.auditLoading' | translate }}</p>
          </div>
          } @else if (auditDialog().logs.length === 0) {
          <div class="text-center py-4 text-secondary">
            <p>{{ 'templates.auditEmpty' | translate }}</p>
          </div>
          } @else {
          <div class="d-flex flex-column gap-3">
            @for (log of auditDialog().logs; track log.id) {
            <div class="d-flex gap-3 p-3 bg-surface border rounded-3">
              <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
                style="width: 32px; height: 32px;" [class.bg-success-subtle]="log.action === 'CREATE'"
                [class.text-success]="log.action === 'CREATE'" [class.bg-primary-subtle]="log.action === 'UPDATE'"
                [class.text-primary]="log.action === 'UPDATE'" [class.bg-danger-subtle]="log.action === 'DELETE'"
                [class.text-danger]="log.action === 'DELETE'">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  @if (log.action === 'CREATE') {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  } @else if (log.action === 'UPDATE') {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  } @else if (log.action === 'DELETE') {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  } @else {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  }
                </svg>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <span class="fw-bold small">{{ log.action }}</span>
                  <span class="text-secondary small">{{ formatTimestamp(log.timestamp) }}</span>
                </div>
                <p class="mb-1 small">{{ log.details }}</p>
                <div class="d-flex gap-3 text-secondary x-small">
                  <span><i class="me-1">User:</i> {{ log.userName }}</span>
                  <span><i class="me-1">IP:</i> {{ log.ipAddress }}</span>
                </div>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
    }
  </div>
</div>