<div class="admin-page-container">
  <div class="admin-page-header">
    <div class="admin-header-content">
      <div class="admin-title-section">
        <h1>{{ 'templates.title' | translate }}</h1>
        <p class="subtitle">{{ 'templates.subtitle' | translate }}</p>
      </div>
      <div class="admin-header-actions">
     
        <!-- Only show New Template button when inside a folder (not in root) -->
        @if (showFolderView() && currentFolderId() !== null) {
          <app-button *hasPermission="'templates:create'" variant="primary" (click)="createNew()" class="responsive-btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span class="btn-text">{{ 'templates.newTemplate' | translate }}</span>
          </app-button>
        }
        <!-- Show New Template button in legacy view (non-folder view) -->
        @if (!showFolderView()) {
          <app-button *hasPermission="'templates:create'" variant="primary" (click)="createNew()" class="responsive-btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span class="btn-text">{{ 'templates.newTemplate' | translate }}</span>
          </app-button>
        }
      </div>
    </div>
  </div>

  <div class="container">
    <div class="admin-filters-section">
      <div class="admin-filters-grid">
        <!-- Search functionality (always visible) -->
        <div class="search-filter">
          <app-search 
            [placeholder]="'templates.searchPlaceholder' | translate"
            [showFilters]="true"
            [templateTypes]="filteredTemplateTypes()"
            (resultSelected)="onSearchResultSelected($event)"
            (searchStateChanged)="onSearchStateChanged($event)"
          ></app-search>
        </div>

    
        <!-- Toolbar actions (replaces the old view toggle section) -->
        <div class="toolbar-actions ms-auto d-flex gap-2">
          @if (showFolderView()) {
            <!-- Back to Root button when in a folder -->
            @if (currentFolderId() !== null) {
              <button class="btn btn-sm btn-outline" (click)="onBreadcrumbClicked({id: null, name: 'Root', path: '/'})" title="Back to Root">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span class="btn-text d-none d-md-inline">Back to Root</span>
              </button>
            }
            
            <!-- Create folder button -->
            <button class="btn btn-sm btn-primary" (click)="createFolder()" title="Create Folder">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              <span class="btn-text d-none d-md-inline">Create Folder</span>
            </button>
            
            <!-- Load All toggle -->
            <!-- <button class="btn btn-sm btn-outline" title="Load All">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
              <span class="btn-text d-none d-md-inline">Load All</span>
            </button> -->
          }
          
          <!-- View toggle buttons (always visible) -->
          <div class="view-toggle d-flex">
           
            <button class="btn btn-icon btn-sm" [class.btn-primary]="activeView() === 'grid'"
              [class.btn-outline]="activeView() !== 'grid'" (click)="activeView.set('grid')"
              title="{{ 'templates.gridView' | translate }}">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M10 3H3v7h7V3zM21 3h-7v7h7V3zM21 14h-7v7h7v-7zM10 14H3v7h7v-7z" />
              </svg>
            </button>
            <button class="btn btn-icon btn-sm" [class.btn-primary]="activeView() === 'list'"
              [class.btn-outline]="activeView() !== 'list'" (click)="activeView.set('list')"
              title="{{ 'templates.listView' | translate }}">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    @if (showFolderView()) {
      <!-- Folder-based view using the folder-content component -->
      <app-folder-content
        [folderId]="currentFolderId()"
        [applicationId]="selectedApp()?.id || null"
        [refreshTrigger]="refreshTrigger()"
        [viewMode]="folderViewMode()"
        (folderSelected)="onFolderSelected($event)"
        (templateSelected)="onTemplateSelected($event)"
        (breadcrumbClicked)="onBreadcrumbClicked($event)"
        (createFolderRequested)="createFolder()"
      ></app-folder-content>
    } @else {
      <!-- Legacy flat view -->
      @if (loading()) {
      <div class="admin-empty-state">
        <div class="spinner"></div>
        <p>{{ 'templates.loading' | translate }}</p>
      </div>
      } @else if (skeletonLoading()) {
      <div class="admin-grid">
        @for (i of [1,2,3,4,5,6]; track i) {
        <div class="admin-card">
          <div class="admin-card-body">
            <div class="skeleton-title"
              style="height: 20px; width: 60%; background: var(--surface-hover); margin-bottom: 1rem; border-radius: 4px;">
            </div>
            <div class="skeleton-text"
              style="height: 14px; width: 80%; background: var(--surface-hover); border-radius: 4px;"></div>
          </div>
        </div>
        }
      </div>
      } @else if (templates().length === 0) {
      <div class="admin-empty-state">
        <div class="empty-icon">
          <svg width="100%" height="100%" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h3>{{ 'templates.emptyTitle' | translate }}</h3>
        <p>{{ 'templates.emptyDesc' | translate }}</p>
        <app-button *hasPermission="'templates:create'" variant="primary" (click)="createNew()">{{ 'templates.createTemplate' | translate }}</app-button>
      </div>
      } @else {
      @if (activeView() === 'grid') {
      <div class="admin-grid">
        @for (template of templates(); track template.id) {
        <div class="admin-card">
          <div class="admin-card-header">
            <span class="status-badge neutral">
              {{ template.type }}
            </span>

          </div>

          <div class="admin-card-body">
            <h3 class="admin-card-title">{{ template.name }}</h3>

            <div class="admin-card-meta">
              <div class="meta-row">
                <span class="label">{{ 'templates.updatedPrefix' | translate }}</span>
                <span class="value">{{ formatDate(template.updatedAt) }}</span>
              </div>
            </div>
          </div>

          <div class="card-footer bg-transparent border-top border-light p-3 d-flex justify-content-end gap-2">
            <button class="btn btn-icon btn-sm btn-ghost" (click)="openAuditDialog(template)"
              title="{{ 'templates.auditHistory' | translate }}">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </button>
            <button *hasPermission="'templates:update'" class="btn btn-icon btn-sm btn-ghost text-primary" (click)="editTemplate(template.id)"
              title="{{ 'common.edit' | translate }}">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </button>
            <button *hasPermission="'templates:create'" class="btn btn-icon btn-sm btn-ghost text-info" (click)="openDuplicateDialog(template)"
              title="{{ 'common.duplicate' | translate }}">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </button>
            <button *hasPermission="'templates:delete'" class="btn btn-icon btn-sm btn-ghost text-danger" (click)="openDeleteDialog(template)"
              title="{{ 'common.delete' | translate }}">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="admin-table-container">
        <table class="admin-table">
          <thead>
            <tr>
              <th>{{ 'templates.table.name' | translate }}</th>
              <th>{{ 'templates.table.type' | translate }}</th>

              <th>{{ 'templates.table.updated' | translate }}</th>
              <th>{{ 'templates.table.actions' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (template of templates(); track template.id) {
            <tr class="cursor-pointer" (click)="editTemplate(template.id)">
              <td><strong>{{ template.name }}</strong></td>
              <td><span class="status-badge neutral">{{ template.type }}</span></td>

              <td>{{ formatDate(template.updatedAt) }}</td>
              <td (click)="$event.stopPropagation()">
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-icon btn-sm btn-ghost" (click)="openAuditDialog(template)"
                    title="{{ 'templates.auditHistory' | translate }}">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </button>
                  <button *hasPermission="'templates:create'" class="btn btn-icon btn-sm btn-ghost text-info" (click)="openDuplicateDialog(template)"
                    title="{{ 'common.duplicate' | translate }}">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                  </button>
                  <button *hasPermission="'templates:delete'" class="btn btn-icon btn-sm btn-ghost text-danger" (click)="openDeleteDialog(template)"
                    title="{{ 'common.delete' | translate }}">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }

      @if (totalPages() > 1) {
      <div class="pagination-container d-flex justify-content-center mt-4">
        <div class="d-flex gap-2">
          <button class="btn btn-icon btn-sm btn-outline" [disabled]="currentPage() === 0"
            (click)="goToPage(currentPage() - 1)">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          @for (page of getPageNumbers(); track page) {
            @if (page === -1) {
              <span class="btn btn-sm btn-outline disabled" style="pointer-events: none;">...</span>
            } @else {
              <button class="btn btn-sm" [class.btn-primary]="page === currentPage()"
                [class.btn-outline]="page !== currentPage()" (click)="goToPage(page)">
                {{ page + 1 }}
              </button>
            }
          }

          <button class="btn btn-icon btn-sm btn-outline" [disabled]="currentPage() === totalPages() - 1"
            (click)="goToPage(currentPage() + 1)">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
      }
      }
    }

    <!-- Dialogs -->
    @if (dialog().show) {
    <div class="modal-overlay" (click)="closeDialog()">
      <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header border-0 pb-0">
          <button class="btn-close ms-auto" (click)="closeDialog()">×</button>
        </div>
        <div class="modal-body text-center pt-0">
          @if (dialog().type === 'delete') {
          <div class="mx-auto rounded-circle d-flex align-items-center justify-content-center mb-3"
            style="width: 48px; height: 48px; background: var(--danger-light); color: var(--danger);">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </div>
          <h2 class="h5 mb-2">{{ 'templates.dialog.deleteTitle' | translate }}</h2>
          <p class="text-secondary mb-0">{{ 'templates.dialog.deleteConfirmPrefix' | translate }} <strong>{{
              dialog().template?.name }}</strong>? {{ 'templates.dialog.cannotUndo' | translate }}</p>
          } @else if (dialog().type === 'duplicate') {
          <div class="mx-auto rounded-circle d-flex align-items-center justify-content-center mb-3"
            style="width: 48px; height: 48px; background: var(--primary-light); color: var(--primary);">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </div>
          <h2 class="h5 mb-2">{{ 'templates.dialog.duplicateTitle' | translate }}</h2>
          <p class="text-secondary mb-0">{{ 'templates.dialog.duplicateConfirmPrefix' | translate }} <strong>{{
              dialog().template?.name }}</strong>?</p>
          }
        </div>
        <div class="modal-footer justify-content-center border-0 pt-0">
          <button class="btn btn-secondary" (click)="closeDialog()" [disabled]="dialog().loading">
            {{ 'common.cancel' | translate }}
          </button>
          <button class="btn" [class.btn-danger]="dialog().type === 'delete'"
            [class.btn-primary]="dialog().type === 'duplicate'" (click)="confirmDialog()" [disabled]="dialog().loading">
            @if (dialog().loading) {
            <span class="spinner-sm me-2"></span>
            <span>{{ 'common.processing' | translate }}</span>
            } @else {
            <span>{{ dialog().type === 'delete' ? ( 'common.delete' | translate ) : ( 'common.duplicate' | translate )
              }}</span>
            }
          </button>
        </div>
      </div>
    </div>
    }



    @if (auditDialog().show) {
    <div class="modal-overlay" (click)="closeAuditDialog()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ 'templates.auditHistory' | translate }}</h2>
          <button class="btn-close" (click)="closeAuditDialog()">×</button>
        </div>

        <div class="modal-body">
          <h3 class="h6 mb-3 text-primary">{{ auditDialog().template?.name }}</h3>

          @if (auditDialog().loading) {
          <div class="text-center py-4">
            <div class="spinner mb-2 mx-auto"></div>
            <p class="text-secondary">{{ 'templates.auditLoading' | translate }}</p>
          </div>
          } @else if (auditDialog().logs.length === 0) {
          <div class="text-center py-4 text-secondary">
            <p>{{ 'templates.auditEmpty' | translate }}</p>
          </div>
          } @else {
          <div class="d-flex flex-column gap-3">
            @for (log of auditDialog().logs; track log.id) {
            <div class="d-flex gap-3 p-3 bg-surface border rounded-3">
              <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
                style="width: 32px; height: 32px;" [class.bg-success-subtle]="log.action === 'CREATE'"
                [class.text-success]="log.action === 'CREATE'" [class.bg-primary-subtle]="log.action === 'UPDATE'"
                [class.text-primary]="log.action === 'UPDATE'" [class.bg-danger-subtle]="log.action === 'DELETE'"
                [class.text-danger]="log.action === 'DELETE'">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  @if (log.action === 'CREATE') {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  } @else if (log.action === 'UPDATE') {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  } @else if (log.action === 'DELETE') {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  } @else {
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  }
                </svg>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start mb-1">
                  <span class="fw-bold small">{{ log.action }}</span>
                  <span class="text-secondary small">{{ formatTimestamp(log.timestamp) }}</span>
                </div>
                <p class="mb-1 small">{{ log.details }}</p>
                <div class="d-flex gap-3 text-secondary x-small">
                  <span><i class="me-1">User:</i> {{ log.userName }}</span>
                  <span><i class="me-1">IP:</i> {{ log.ipAddress }}</span>
                </div>
              </div>
            </div>
            }
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- Create Folder Dialog -->
    @if (showCreateFolderDialog()) {
    <div class="modal-overlay" (click)="cancelCreateFolder()">
      <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="h5 mb-0">{{ 'templates.createFolder' | translate }}</h2>
          <button class="btn-close" (click)="cancelCreateFolder()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="folderName" class="form-label">{{ 'templates.folderName' | translate }}</label>
            <input 
              type="text" 
              id="folderName"
              class="form-control" 
              [value]="newFolderName()"
              (input)="newFolderName.set($any($event.target).value)"
              [placeholder]="'templates.folderNamePlaceholder' | translate"
              (keyup.enter)="confirmCreateFolder()"
              #folderNameInput>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cancelCreateFolder()">
            {{ 'common.cancel' | translate }}
          </button>
          <button class="btn btn-primary" (click)="confirmCreateFolder()" [disabled]="!newFolderName().trim()">
            {{ 'common.create' | translate }}
          </button>
        </div>
      </div>
    </div>
    }
  </div>
</div>